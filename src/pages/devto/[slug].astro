---
import Base from '../../layouts/Base.astro';
import ShareLinks from '../../components/ShareLinks.astro';

export async function getStaticPaths() {
  const delay = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

  const listResponse = await fetch('https://dev.to/api/articles?username=mike-vincent&per_page=100');
  const articlesList = await listResponse.json();

  // Fetch full articles with delay to avoid rate limiting
  const fullArticles = [];
  for (const article of articlesList) {
    await delay(300); // 300ms delay between requests
    try {
      const response = await fetch(`https://dev.to/api/articles/${article.id}`);
      if (response.ok) {
        const fullArticle = await response.json();
        fullArticles.push(fullArticle);
      }
    } catch (e) {
      console.error(`Failed to fetch article ${article.id}:`, e);
    }
  }

  return fullArticles.map((article: any) => ({
    params: { slug: article.slug },
    props: { article },
  }));
}

const { slug } = Astro.params;
const { article } = Astro.props;

const title = article.title;
const subtitle = article.description;
const date = new Date(article.published_at);
const tags = article.tags || [];
const image = article.cover_image;
const bodyHtml = article.body_html;

const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
const isoDate = date.toISOString().split('T')[0];
const url = `https://mikevincent.dev/devto/${slug}/`;
const devtoUrl = article.url;
---

<Base title={`${title} - Mike Vincent`} description={subtitle} image={image}>
  <div class="section-content">
    <div class="row">
      <div class="column large-centered large-10 small-12">
        <div class="post-content">
          <div class="post-header">
            <div class="post-header-text">
              <div class="title-row">
                <h1 transition:name={`title-devto-${article.id}`}>{title}</h1>
                <button class="post-menu" aria-label="More options"><span class="material-symbols-outlined">more_vert</span></button>
              </div>
              <p class="subtitle">{subtitle}</p>
            </div>
          </div>

          {image && <img src={image} alt="" class="post-image" />}

          <div class="body devto-body">
            <Fragment set:html={bodyHtml} />
          </div>

          <p class="devto-source">
            <a href={devtoUrl} target="_blank" rel="noopener noreferrer">Read on dev.to â†’</a>
          </p>

          <ul class="post-tags">
            {tags.map((tag: string) => (
              <li><a href={`/tags/#${tag}`}>#{tag}</a></li>
            ))}
          </ul>
        </div>

        <ShareLinks title={title} url={url} />
      </div>
    </div>
  </div>
</Base>

<style>
  .post-content h1 {
    font-size: 18px;
    font-weight: 600;
    margin: 0 0 4px;
  }
  :global(.theme-dark) .post-content h1 { color: #fff; }
  :global(.theme-light) .post-content h1 { color: #000; }

  .post-content .body .dateline {
    font-size: 16px;
  }

  .devto-source {
    margin: 24px 0;
    font-size: 14px;
  }
  .devto-source a {
    color: #007AFF;
    text-decoration: none;
  }
  .devto-source a:hover {
    text-decoration: underline;
  }

  /* Style dev.to content */
  .devto-body :global(h2) {
    font-size: 18px;
    font-weight: 600;
    margin: 24px 0 12px;
  }
  .devto-body :global(h3) {
    font-size: 16px;
    font-weight: 600;
    margin: 20px 0 10px;
  }
  .devto-body :global(pre) {
    padding: 16px;
    border-radius: 8px;
    overflow-x: auto;
    font-size: 14px;
    line-height: 1.5;
  }
  :global(.theme-dark) .devto-body :global(pre) { background: #1a1a1a; }
  :global(.theme-light) .devto-body :global(pre) { background: #f5f5f5; }

  .devto-body :global(code) {
    font-family: "SF Mono", Menlo, Monaco, monospace;
    font-size: 14px;
  }
  .devto-body :global(p code) {
    padding: 2px 6px;
    border-radius: 4px;
  }
  :global(.theme-dark) .devto-body :global(p code) { background: #333; }
  :global(.theme-light) .devto-body :global(p code) { background: #eee; }

  .devto-body :global(ul), .devto-body :global(ol) {
    margin: 16px 0;
    padding-left: 24px;
  }
  .devto-body :global(li) {
    margin-bottom: 8px;
  }
  .devto-body :global(img) {
    max-width: 100%;
    border-radius: 8px;
    margin: 16px 0;
  }
  .devto-body :global(blockquote) {
    margin: 16px 0;
    padding-left: 16px;
    border-left: 3px solid #007AFF;
    font-style: italic;
  }
</style>
